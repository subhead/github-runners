# docker-compose/linux-full.yml
# Full stack GitHub Actions runner configuration (LEGACY/MONOLITH SUPPORT)
# Contains Python, C++, Node.js, and Go - for migration or maximum compatibility

version: '3.8'

networks:
  github-runners:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:
  full-runner:
    # Build the full stack composite image
    build:
      context: ../
      dockerfile: docker/linux/composite/Dockerfile.full-stack
      target: gh-runner:full-stack
      # Optional: Build arguments
      args:
        RUNNER_VERSION: 2.331.0
        NODE_VERSION: 20
        GO_VERSION: 1.22.7
    image: gh-runner:full-stack
    container_name: github-full-runner
    hostname: full-runner

    # Resource limits for full stack (larger due to multiple languages)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

    # Memory and CPU limits
    mem_limit: 8g
    mem_reservation: 4g
    cpus: '4.0'
    cpu_shares: 1024

    # Environment variables (REQUIRED)
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:?GITHUB_TOKEN environment variable is required}
      # Choose ONE: GITHUB_OWNER for org runners, GITHUB_REPOSITORY for repo runners
      - GITHUB_OWNER=${GITHUB_OWNER}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - RUNNER_NAME=${RUNNER_NAME:-full-runner-01}
      - RUNNER_LABELS=${RUNNER_LABELS:-linux,full,all,legacy,python,cpp,nodejs,go,flutter,dart}
      - RUNNER_GROUP=${RUNNER_GROUP:-Default}
      - RUNNER_WORKDIR=${RUNNER_WORKDIR:-_work}
      - RUNNER_AS_ROOT=${RUNNER_AS_ROOT:-false}
      - RUNNER_REPLACE_EXISTING=${RUNNER_REPLACE_EXISTING:-false}

    # Optional environment variables for all stacks
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - PYTHONDONTWRITEBYTECODE=${PYTHONDONTWRITEBYTECODE:-1}
      - PIP_NO_CACHE_DIR=${PIP_NO_CACHE_DIR:-off}
      - PIP_DISABLE_PIP_VERSION_CHECK=${PIP_DISABLE_PIP_VERSION_CHECK:-on}
      - NODE_ENV=${NODE_ENV:-production}
      - NODE_OPTIONS=${NODE_OPTIONS:--max-old-space-size=4096}
      - NPM_CONFIG_CACHE=${NPM_CONFIG_CACHE:-/home/runner/.npm-global}
      - YARN_CACHE_FOLDER=${YARN_CACHE_FOLDER:-/home/runner/.yarn-cache}
      - PNPM_HOME=${PNPM_HOME:-/home/runner/.local/share/pnpm}
      - GOPATH=${GOPATH:-/go}
      - GOROOT=${GOROOT:-/usr/local/go}
      - GO111MODULE=${GO111MODULE:-on}
      - GOBIN=${GOBIN:-/go/bin}
      - FLUTTER_HOME=${FLUTTER_HOME:-/opt/flutter}
      - ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-/opt/android-sdk}
      - ANDROID_LICENSE_AGREEMENT=${ANDROID_LICENSE_AGREEMENT:-yes}
      - PUB_CACHE=${PUB_CACHE:-/opt/flutter/.pub-cache}
      - CC=${CC:-/usr/bin/gcc}
      - CXX=${CXX:-/usr/bin/g++}
      - BUILD_TYPE=${BUILD_TYPE:-Release}
      - CMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE:-Release}

    # Volumes
    volumes:
      # Docker socket for container builds (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Persistent runner data
      - ./data/full-runner:/actions-runner

      # Python caches
      - ./data/full-python-pip-cache:/home/runner/.cache/pip
      - ./data/full-python-wheel-cache:/home/runner/.cache/pip/wheels
      - ./data/full-python-venv-cache:/home/runner/.venv
      - ./data/full-python-local-lib:/home/runner/.local/lib/python3.10/site-packages

      # C++ caches
      - ./data/full-cpp-build-cache:/home/runner/.cache
      - ./data/full-cpp-conan-cache:/home/runner/.conan
      - ./data/full-cpp-vcpkg-cache:/home/runner/.vcpkg

      # Node.js caches
      - ./data/full-node-npm-cache:/home/runner/.npm-global
      - ./data/full-node-yarn-cache:/home/runner/.yarn-cache
      - ./data/full-node-pnpm-cache:/home/runner/.local/share/pnpm

      # Go caches
      - ./data/full-go-pkg-cache:/go/pkg/mod
      - ./data/full-go-bin-cache:/go/bin

      # Flutter caches
      - ./data/full-flutter-pub-cache:/opt/flutter/.pub-cache
      - ./data/full-flutter-cache:/opt/flutter/bin/cache
      - ./data/full-android-sdk:/opt/android-sdk

      # Optional: Shared ML models cache
      - ./data/full-ml-cache:/home/runner/.cache/ml

      # Optional: Source code mounting for local development
      # - /path/to/your/project:/workspace:ro

    # Network configuration
    networks:
      - github-runners

    # Restart policy
    restart: unless-stopped

    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
        env: "os,customer"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080 || pgrep run.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Labels for monitoring
    labels:
      - "service=github-runner"
      - "language=full-stack"
      - "role=build"
      - "environment=production"
      - "legacy=true"

    # User configuration
    user: "1001:1001"

    # Depends on (optional - add service names here if needed)
    # depends_on:
    #   - other-service

# Profile for selective deployment
# profiles:
#   - full
#   - legacy
#   - monolith
#   - github
