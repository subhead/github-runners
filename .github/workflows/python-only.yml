# Python Development Workflow
# Uses: gh-runner:python-only (~450MB)
# Runner labels: linux, python, ml

name: Python Development

on:
  # Trigger on push to main or develop branches
  push:
    branches:
      - main
      - develop
      - staging
  # Trigger on pull requests
  pull_request:
    branches:
      - main
      - develop
  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Cache key based on runner OS and requirements files
env:
  PYTHON_VERSION: '3.10'
  POETRY_VERSION: '1.7.0'

jobs:
  # ============================================
  # LINT JOB
  # ============================================
  lint:
    runs-on: [self-hosted, linux, python]
    strategy:
      matrix:
        linter: [flake8, black, isort, mypy]
    continue-on-error: true

    steps:
      # ============================================
      # Checkout code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # Setup Python
      # ============================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ============================================
      # Install dependencies
      # ============================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy pytest

      # ============================================
      # Run linters
      # ============================================
      - name: Run ${{ matrix.linter }}
        run: |
          case "${{ matrix.linter }}" in
            flake8)
              flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
              ;;
            black)
              black --check src/ tests/
              ;;
            isort)
              isort --check-only src/ tests/
              ;;
            mypy)
              mypy src/ --ignore-missing-imports
              ;;
          esac

  # ============================================
  # UNIT TEST JOB
  # ============================================
  test:
    runs-on: [self-hosted, linux, python]
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    continue-on-error: false

    steps:
      # ============================================
      # Checkout code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # Setup Python
      # ============================================
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # ============================================
      # Cache dependencies
      # ============================================
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ============================================
      # Install dependencies
      # ============================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov pytest-xdist pytest-mock

      # ============================================
      # Run unit tests
      # ============================================
      - name: Run unit tests
        run: |
          pytest tests/ \
            --cov=src/ \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=test-results/junit.xml \
            --verbose \
            --numprocesses=auto

      # ============================================
      # Upload test results
      # ============================================
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}-${{ github.run_id }}
          path: |
            test-results/
            htmlcov/
            coverage.xml
          retention-days: 7

      # ============================================
      # Upload coverage to Codecov
      # ============================================
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ============================================
  # INTEGRATION TEST JOB
  # ============================================
  integration-test:
    runs-on: [self-hosted, linux, python]
    needs: test
    environment: staging
    continue-on-error: false

    steps:
      # ============================================
      # Checkout code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # Setup Python
      # ============================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ============================================
      # Install dependencies
      # ============================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt 2>/dev/null || true

      # ============================================
      # Run integration tests
      # ============================================
      - name: Run integration tests
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          pytest tests/integration/ \
            --timeout=60 \
            --junitxml=test-results/integration.xml \
            --verbose

      # ============================================
      # Upload integration test results
      # ============================================
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results-${{ github.run_id }}
          path: test-results/integration.xml
          retention-days: 7

  # ============================================
  # BUILD JOB (for packages)
  # ============================================
  build-package:
    runs-on: [self-hosted, linux, python]
    needs: test
    continue-on-error: false

    steps:
      # ============================================
      # Checkout code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # Setup Python
      # ============================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ============================================
      # Install build tools
      # ============================================
      - name: Install build tools
        run: |
          pip install build twine wheel setuptools

      # ============================================
      # Build package
      # ============================================
      - name: Build package
        run: |
          python -m build --wheel --sdist

      # ============================================
      # Verify package
      # ============================================
      - name: Verify package
        run: |
          twine check dist/*

      # ============================================
      # Upload artifacts
      # ============================================
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-${{ github.run_id }}
          path: dist/
          retention-days: 7

  # ============================================
  # DOCKER BUILD JOB
  # ============================================
  build-docker:
    runs-on: [self-hosted, linux, python, docker]
    needs: test
    strategy:
      matrix:
        tag: [latest, '3.10', '3.11']
    continue-on-error: false

    steps:
      # ============================================
      # Checkout code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # Setup Docker Buildx
      # ============================================
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================
      # Login to Docker Hub
      # ============================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ============================================
      # Build and push Docker image
      # ============================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/myapp:${{ matrix.tag }}
            ${{ secrets.DOCKER_USERNAME }}/myapp:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/myapp:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/myapp:buildcache,mode=max

      # ============================================
      # Run security scan
      # ============================================
      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/myapp:${{ matrix.tag }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # SECURITY SCANNING JOB
  # ============================================
  security:
    runs-on: [self-hosted, linux, python]
    continue-on-error: true

    steps:
      # ============================================
      # Checkout code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # Run safety check
      # ============================================
      - name: Run safety check
        run: |
          pip install safety
          safety check --json || echo "Safety check found vulnerabilities"

      # ============================================
      # Run Bandit (security linter)
      # ============================================
      - name: Run Bandit
        run: |
          pip install bandit
          bandit -r src/ -f json -o bandit-results.json || echo "Bandit found issues"

      # ============================================
      # Upload security results
      # ============================================
      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-results-${{ github.run_id }}
          path: |
            bandit-results.json
            safety-report.json
          retention-days: 7

  # ============================================
  # DEPLOY JOB (Optional)
  # ============================================
  deploy:
    runs-on: [self-hosted, linux, python]
    needs: [build-package, build-docker]
    environment: ${{ github.event.inputs.environment || 'staging' }}
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')

    steps:
      # ============================================
      # Checkout code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # Download package artifact
      # ============================================
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          pattern: python-package-*
          merge-multiple: true
          path: dist/

      # ============================================
      # Deploy to server
      # ============================================
      - name: Deploy to server
        run: |
          echo "Deployment script would go here"
          # Add your deployment script
          # ./deploy-python.sh
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}

      # ============================================
      # Run smoke tests
      # ============================================
      - name: Run smoke tests
        run: |
          echo "Smoke tests would go here"
          # Add your smoke test script
          # ./smoke-test.sh

  # ============================================
  # POST-BUILD CLEANUP
  # ============================================
  cleanup:
    runs-on: [self-hosted, linux, python]
    needs: [lint, test, integration-test, build-package, build-docker, security]
    if: always()

    steps:
      - name: Cleanup build artifacts
        run: |
          echo "Cleaning up build artifacts..."
          rm -rf dist/ htmlcov/ test-results/ coverage.xml
          echo "Cleanup complete"

  # ============================================
  # NOTIFICATION JOB
  # ============================================
  notify:
    runs-on: [self-hosted, linux, python]
    needs: [test, integration-test, security]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "Python CI/CD pipeline completed"
          echo "Test status: ${{ needs.test.result }}"
          echo "Integration test status: ${{ needs.integration-test.result }}"
          echo "Security scan status: ${{ needs.security.result }}"
          # Add your notification logic here
          # curl -X POST $SLACK_WEBHOOK_URL -d '{"text":"Python CI complete"}'
